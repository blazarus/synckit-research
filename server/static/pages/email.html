<html>
<head>
    <link rel="stylesheet" type="text/css" href="/static/stylesheets/style.css" /> 
    <script type="text/javascript" src="/static/javascripts/gears_init.js"></script>
    <script type="text/javascript" src="/static/javascripts/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="/static/javascripts/json-template.js"></script>
    <script type="text/javascript" src="/static/javascripts/sync.js"></script>
    <script type="text/javascript" src="/static/javascripts/template.js"></script>
    <script type="text/javascript" src="/static/javascripts/pretty_json.js"></script>

<script>
$(function() {
    console.info("Page Loaded");
    window.db = create_synckit();
    
    /*
     * TODO: Actively set client schema instead of lazily doing it on server respnse.
     */
    
    /*
     * remove_views describes the server-generated managed data structures that are 
     * exported to the client. Each one is a table, but a table that is accessed (and thus synced)
     * in a particular way.  
     */
    var remote_views = {
      "Messages":{
        "type":"queue",
        "field":"date",
        "order":"ASC"
      },
      "Tags":{
        "type":"set",
        "field":"id"
      }
    };
    
    /*
     * The state represents what elements from the remove_views that the client has, so that the
     * server will not waste resources duplicating information.
     */
    var state = window.db.get_state(remote_views);        
    // var state = {};
    var endpoint = "http://localhost:8080/email/inbox";
    
    var params = {"queries":JSON.stringify(state)};    

    /*
     * The dataspec is a structure which, given the client database, describes a JSON object
     * to be filled-in with SQL results that should be combined with the template for this page.
     */
    var dataspec = {
       "messages":"SELECT * FROM Messages;",
    };
    
    /*
     * This is the HTML template for the page.
     */
    var template = "<div>{# This is a comment and will be removed from the output.}{.section messages}<h2>Mails</h2><table width='100%'>{.repeated section @}<tr><td>{from_email}</td><td>{subject}</td></tr>{.end}</table>{.or}<p><em>(No mails)</em></p>{.end}</div>";

    console.info("Endpoint: " + endpoint);    
    console.info("Params: " + JSON.stringify(params));
    
    $.post(endpoint, params, function(data) {
        console.info("Server Response");
        console.info(JSON.stringify(data));    
        window.db.bulkload(data);
//        var data = window.db.process_data_spec(dataspec);
//        $('#templated').template(template);
//        $('#templated').templateData(data);
//        $('#templated').render();

		  $('#newtemplate').render_new();
	      // Do the new render
	      
	      
    }, "json");
    
});
</script>
</head>
<body>
    
    
                
                
                
    <p>{.field}</p>
</div>
    
    
    
    
    
<div id="loading">
    <button onclick="window.db.reset();">Reset DB</button><button onclick="window.db.dump();">Dump DB</button>
</div>
<div id="debug">
</div>
<div id="templated">
<p align="center"><b>Template Loading...</b></p>
</div>

<table id="newtemplate" query="SELECT * From Messages LIMIT 10;" as="message">
	<tr itemscope="yes" itemtype="Message" />
		<td><span itemprop="from_email">from</span></td>
		<td><span itemprop="subject">subject</span></td>
	</tr>
</table>

</body>

</html>
